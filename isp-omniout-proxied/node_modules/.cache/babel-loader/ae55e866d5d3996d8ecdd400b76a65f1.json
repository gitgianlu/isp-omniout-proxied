{"ast":null,"code":"/**\n * @file Browser client connection management class\n * @author Shinichi Tomita <shinichi.tomita@gmail.com>\n */\n'use strict';\n\nvar events = require('events'),\n    inherits = require('inherits'),\n    qs = require('querystring'),\n    _ = require('lodash/core'),\n    Connection = require('../connection'),\n    OAuth2 = require('../oauth2');\n/**\n * @private\n */\n\n\nfunction popupWin(url, w, h) {\n  var left = screen.width / 2 - w / 2;\n  var top = screen.height / 2 - h / 2;\n  return window.open(url, null, 'location=yes,toolbar=no,status=no,menubar=no,width=' + w + ',height=' + h + ',top=' + top + ',left=' + left);\n}\n\nfunction handleCallbackResponse() {\n  var res = checkCallbackResponse();\n  var state = localStorage.getItem('jsforce_state');\n\n  if (res && state && res.body.state === state) {\n    localStorage.removeItem('jsforce_state');\n    var states = state.split('.');\n    var prefix = states[0],\n        promptType = states[1];\n    var cli = new Client(prefix);\n\n    if (res.success) {\n      cli._storeTokens(res.body);\n\n      location.hash = '';\n    } else {\n      cli._storeError(res.body);\n    }\n\n    if (promptType === 'popup') {\n      window.close();\n    }\n\n    return true;\n  }\n}\n/**\n * @private\n */\n\n\nfunction checkCallbackResponse() {\n  var params;\n\n  if (window.location.hash) {\n    params = qs.parse(window.location.hash.substring(1));\n\n    if (params.access_token) {\n      return {\n        success: true,\n        body: params\n      };\n    }\n  } else if (window.location.search) {\n    params = qs.parse(window.location.search.substring(1));\n\n    if (params.error) {\n      return {\n        success: false,\n        body: params\n      };\n    }\n  }\n}\n/** @private **/\n\n\nvar clientIdx = 0;\n/**\n * @class\n * @todo add document\n */\n\nvar Client = function (prefix) {\n  this._prefix = prefix || 'jsforce' + clientIdx++;\n  this.connection = null;\n};\n\ninherits(Client, events.EventEmitter);\n/**\n *\n */\n\nClient.prototype.init = function (config) {\n  if (handleCallbackResponse()) {\n    return;\n  }\n\n  this.config = config;\n  this.connection = new Connection(config);\n\n  var tokens = this._getTokens();\n\n  if (tokens) {\n    this.connection.initialize(tokens);\n    var self = this;\n    setTimeout(function () {\n      self.emit('connect', self.connection);\n    }, 10);\n  }\n};\n/**\n *\n */\n\n\nClient.prototype.login = function (options, callback) {\n  if (_.isFunction(options)) {\n    callback = options;\n    options = {};\n  }\n\n  options = options || {};\n\n  callback = callback || function () {};\n\n  _.extend(options, this.config);\n\n  var self = this;\n\n  this._prompt(options, callback);\n};\n\nClient.prototype._prompt = function (options, callback) {\n  var self = this;\n  var oauth2 = new OAuth2(options);\n  var rand = Math.random().toString(36).substring(2);\n  var state = [this._prefix, \"popup\", rand].join('.');\n  localStorage.setItem(\"jsforce_state\", state);\n  var authzUrl = oauth2.getAuthorizationUrl({\n    response_type: 'token',\n    scope: options.scope,\n    state: state\n  });\n  var size = options.size || {};\n  var pw = popupWin(authzUrl, size.width || 912, size.height || 513);\n\n  if (!pw) {\n    state = [this._prefix, \"redirect\", rand].join('.');\n    localStorage.setItem(\"jsforce_state\", state);\n    authzUrl = oauth2.getAuthorizationUrl({\n      response_type: 'token',\n      scope: options.scope,\n      state: state\n    });\n    location.href = authzUrl;\n    return;\n  }\n\n  self._removeTokens();\n\n  var pid = setInterval(function () {\n    try {\n      if (!pw || pw.closed) {\n        clearInterval(pid);\n\n        var tokens = self._getTokens();\n\n        if (tokens) {\n          self.connection.initialize(tokens);\n          self.emit('connect', self.connection);\n          callback(null, {\n            status: 'connect'\n          });\n        } else {\n          var err = self._getError();\n\n          if (err) {\n            callback(new Error(err.error + \": \" + err.error_description));\n          } else {\n            callback(null, {\n              status: 'cancel'\n            });\n          }\n        }\n      }\n    } catch (e) {}\n  }, 1000);\n};\n/**\n *\n */\n\n\nClient.prototype.isLoggedIn = function () {\n  return !!(this.connection && this.connection.accessToken);\n};\n/**\n *\n */\n\n\nClient.prototype.logout = function () {\n  this.connection.logout();\n\n  this._removeTokens();\n\n  this.emit('disconnect');\n};\n/**\n * @private\n */\n\n\nClient.prototype._getTokens = function () {\n  var regexp = new RegExp(\"(^|;\\\\s*)\" + this._prefix + \"_loggedin=true(;|$)\");\n\n  if (document.cookie.match(regexp)) {\n    var issuedAt = Number(localStorage.getItem(this._prefix + '_issued_at'));\n\n    if (Date.now() < issuedAt + 2 * 60 * 60 * 1000) {\n      // 2 hours\n      var userInfo;\n      var idUrl = localStorage.getItem(this._prefix + '_id');\n\n      if (idUrl) {\n        var ids = idUrl.split('/');\n        userInfo = {\n          id: ids.pop(),\n          organizationId: ids.pop(),\n          url: idUrl\n        };\n      }\n\n      return {\n        accessToken: localStorage.getItem(this._prefix + '_access_token'),\n        instanceUrl: localStorage.getItem(this._prefix + '_instance_url'),\n        userInfo: userInfo\n      };\n    }\n  }\n\n  return null;\n};\n/**\n * @private\n */\n\n\nClient.prototype._storeTokens = function (params) {\n  localStorage.setItem(this._prefix + '_access_token', params.access_token);\n  localStorage.setItem(this._prefix + '_instance_url', params.instance_url);\n  localStorage.setItem(this._prefix + '_issued_at', params.issued_at);\n  localStorage.setItem(this._prefix + '_id', params.id);\n  document.cookie = this._prefix + '_loggedin=true;';\n};\n/**\n * @private\n */\n\n\nClient.prototype._removeTokens = function () {\n  localStorage.removeItem(this._prefix + '_access_token');\n  localStorage.removeItem(this._prefix + '_instance_url');\n  localStorage.removeItem(this._prefix + '_issued_at');\n  localStorage.removeItem(this._prefix + '_id');\n  document.cookie = this._prefix + '_loggedin=';\n};\n/**\n * @private\n */\n\n\nClient.prototype._getError = function () {\n  try {\n    var err = JSON.parse(localStorage.getItem(this._prefix + '_error'));\n    localStorage.removeItem(this._prefix + '_error');\n    return err;\n  } catch (e) {}\n};\n/**\n * @private\n */\n\n\nClient.prototype._storeError = function (err) {\n  localStorage.setItem(this._prefix + '_error', JSON.stringify(err));\n};\n/**\n *\n */\n\n\nmodule.exports = new Client();\nmodule.exports.Client = Client;","map":{"version":3,"sources":["/Users/gcarminati/Desktop/OmniStudio/OmniProxy/react-express-proxy-sample/node_modules/jsforce/lib/browser/client.js"],"names":["events","require","inherits","qs","_","Connection","OAuth2","popupWin","url","w","h","left","screen","width","top","height","window","open","handleCallbackResponse","res","checkCallbackResponse","state","localStorage","getItem","body","removeItem","states","split","prefix","promptType","cli","Client","success","_storeTokens","location","hash","_storeError","close","params","parse","substring","access_token","search","error","clientIdx","_prefix","connection","EventEmitter","prototype","init","config","tokens","_getTokens","initialize","self","setTimeout","emit","login","options","callback","isFunction","extend","_prompt","oauth2","rand","Math","random","toString","join","setItem","authzUrl","getAuthorizationUrl","response_type","scope","size","pw","href","_removeTokens","pid","setInterval","closed","clearInterval","status","err","_getError","Error","error_description","e","isLoggedIn","accessToken","logout","regexp","RegExp","document","cookie","match","issuedAt","Number","Date","now","userInfo","idUrl","ids","id","pop","organizationId","instanceUrl","instance_url","issued_at","JSON","stringify","module","exports"],"mappings":"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","sourcesContent":["/**\n * @file Browser client connection management class\n * @author Shinichi Tomita <shinichi.tomita@gmail.com>\n */\n\n'use strict';\n\nvar events = require('events'),\n    inherits = require('inherits'),\n    qs = require('querystring'),\n    _ = require('lodash/core'),\n    Connection = require('../connection'),\n    OAuth2 = require('../oauth2');\n\n/**\n * @private\n */\nfunction popupWin(url, w, h) {\n  var left = (screen.width/2)-(w/2);\n  var top = (screen.height/2)-(h/2);\n  return window.open(url, null, 'location=yes,toolbar=no,status=no,menubar=no,width='+w+',height='+h+',top='+top+',left='+left);\n}\n\nfunction handleCallbackResponse() {\n  var res = checkCallbackResponse();\n  var state = localStorage.getItem('jsforce_state');\n  if (res && state && res.body.state === state) {\n    localStorage.removeItem('jsforce_state');\n    var states = state.split('.');\n    var prefix = states[0], promptType = states[1];\n    var cli = new Client(prefix);\n    if (res.success) {\n      cli._storeTokens(res.body);\n      location.hash = '';\n    } else {\n      cli._storeError(res.body);\n    }\n    if (promptType === 'popup') { window.close(); }\n    return true;\n  }\n}\n\n/**\n * @private\n */\nfunction checkCallbackResponse() {\n  var params;\n  if (window.location.hash) {\n    params = qs.parse(window.location.hash.substring(1));\n    if (params.access_token) {\n      return { success: true, body: params };\n    }\n  } else if (window.location.search) {\n    params = qs.parse(window.location.search.substring(1));\n    if (params.error) {\n      return { success: false, body: params };\n    }\n  }\n}\n\n/** @private **/\nvar clientIdx = 0;\n\n\n/**\n * @class\n * @todo add document\n */\nvar Client = function(prefix) {\n  this._prefix = prefix || 'jsforce' + clientIdx++;\n  this.connection = null;\n};\n\ninherits(Client, events.EventEmitter);\n\n/**\n *\n */\nClient.prototype.init = function(config) {\n  if (handleCallbackResponse()) { return; }\n  this.config = config;\n  this.connection = new Connection(config);\n  var tokens = this._getTokens();\n  if (tokens) {\n    this.connection.initialize(tokens);\n    var self = this;\n    setTimeout(function() {\n      self.emit('connect', self.connection);\n    }, 10);\n  }\n};\n\n/**\n *\n */\nClient.prototype.login = function(options, callback) {\n  if (_.isFunction(options)) {\n    callback = options;\n    options = {};\n  }\n  options = options || {};\n  callback = callback || function(){ };\n  _.extend(options, this.config);\n  var self = this;\n  this._prompt(options, callback);\n};\n\n\nClient.prototype._prompt = function(options, callback) {\n  var self = this;\n  var oauth2 = new OAuth2(options);\n  var rand = Math.random().toString(36).substring(2);\n  var state = [ this._prefix, \"popup\", rand ].join('.');\n  localStorage.setItem(\"jsforce_state\", state);\n  var authzUrl = oauth2.getAuthorizationUrl({\n    response_type: 'token',\n    scope : options.scope,\n    state: state\n  });\n  var size = options.size || {};\n  var pw = popupWin(authzUrl, size.width || 912, size.height || 513);\n  if (!pw) {\n    state = [ this._prefix, \"redirect\", rand ].join('.');\n    localStorage.setItem(\"jsforce_state\", state);\n    authzUrl = oauth2.getAuthorizationUrl({\n      response_type: 'token',\n      scope : options.scope,\n      state: state\n    });\n    location.href = authzUrl;\n    return;\n  }\n  self._removeTokens();\n  var pid = setInterval(function() {\n    try {\n      if (!pw || pw.closed) {\n        clearInterval(pid);\n        var tokens = self._getTokens();\n        if (tokens) {\n          self.connection.initialize(tokens);\n          self.emit('connect', self.connection);\n          callback(null, { status: 'connect' });\n        } else {\n          var err = self._getError();\n          if (err) {\n            callback(new Error(err.error + \": \" + err.error_description));\n          } else {\n            callback(null, { status: 'cancel' });\n          }\n        }\n      }\n    } catch(e) {}\n  }, 1000);\n};\n\n/**\n *\n */\nClient.prototype.isLoggedIn = function() {\n  return !!(this.connection && this.connection.accessToken);\n};\n\n/**\n *\n */\nClient.prototype.logout = function() {\n  this.connection.logout();\n  this._removeTokens();\n  this.emit('disconnect');\n};\n\n/**\n * @private\n */\nClient.prototype._getTokens = function() {\n  var regexp = new RegExp(\"(^|;\\\\s*)\"+this._prefix+\"_loggedin=true(;|$)\");\n  if (document.cookie.match(regexp)) {\n    var issuedAt = Number(localStorage.getItem(this._prefix+'_issued_at'));\n    if (Date.now() < issuedAt + 2 * 60 * 60 * 1000) { // 2 hours\n      var userInfo;\n      var idUrl = localStorage.getItem(this._prefix + '_id');\n      if (idUrl) {\n        var ids = idUrl.split('/');\n        userInfo = { id: ids.pop(), organizationId: ids.pop(), url: idUrl };\n      }\n      return {\n        accessToken: localStorage.getItem(this._prefix + '_access_token'),\n        instanceUrl: localStorage.getItem(this._prefix + '_instance_url'),\n        userInfo: userInfo\n      };\n    }\n  }\n  return null;\n};\n\n/**\n * @private\n */\nClient.prototype._storeTokens = function(params) {\n  localStorage.setItem(this._prefix + '_access_token', params.access_token);\n  localStorage.setItem(this._prefix + '_instance_url', params.instance_url);\n  localStorage.setItem(this._prefix + '_issued_at', params.issued_at);\n  localStorage.setItem(this._prefix + '_id', params.id);\n  document.cookie = this._prefix + '_loggedin=true;';\n};\n\n/**\n * @private\n */\nClient.prototype._removeTokens = function() {\n  localStorage.removeItem(this._prefix + '_access_token');\n  localStorage.removeItem(this._prefix + '_instance_url');\n  localStorage.removeItem(this._prefix + '_issued_at');\n  localStorage.removeItem(this._prefix + '_id');\n  document.cookie = this._prefix + '_loggedin=';\n};\n\n/**\n * @private\n */\nClient.prototype._getError = function() {\n  try {\n    var err = JSON.parse(localStorage.getItem(this._prefix + '_error'));\n    localStorage.removeItem(this._prefix + '_error');\n    return err;\n  } catch(e) {}\n};\n\n/**\n * @private\n */\nClient.prototype._storeError = function(err) {\n  localStorage.setItem(this._prefix + '_error', JSON.stringify(err));\n};\n\n/**\n *\n */\nmodule.exports = new Client();\n\nmodule.exports.Client = Client;\n"]},"metadata":{},"sourceType":"script"}